# Kafka Trigger
## Description

---
**Kafka Trigger** element allows to integrate the chain with Apache Kafka message broker and setup messages consumption from specific topic.

<div style="background-color: #e7f3fe; border-left: 6px solid #2196F3; padding: 10px">According to <b>Apache Camel</b> framework, when chain is triggered, system creates <b>Exchange Object</b>, that handles input data following the logic, described in respective article: <a href="doc/00__Overview/2__Apache_Camel_Context_Concept/apache_camel_context_concept.md">Apache Camel Context Concept</a>.</div>

## User Interface

---
### "Parameters" Tab
#### Common Parameters

- **"Manual"** connection source type

| Parameter                                        | <div style="width:75px">Mandatory</div> | <div style="width:75px">Data Type</div> | Description                                                                                                                                                                                                                                                                                                 | Sample                                                                                                                             |
| ------------------------------------------------ | :-------------------------------------- | :-------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------- |
| <div style="width:150px">Brokers</div>           | M                                       | String                                  | <div style="width:400px">Address of Kafka brokers. List can contain subset of brokers or a VIP pointing to the subset of brokers. Equivalent of bootstrap.servers in the Kafka documentation.<pre style="background-color: #F5F5F7"><code style="color: #000000">host1:port1,host2:port2</code></pre></div> | <div style="width:350px">kafka-broker:8808</div>                                                                                   |
| <div style="width:150px">Topics</div>            | M                                       | String                                  | <div style="width:400px">Name of the Kafka topic(s), from where messages will be consumed. In case of necessity to specify multiple topics use comma (without spaces) to separate topic names.<pre style="background-color: #F5F5F7"><code style="color: #000000">topic1,topic2,topic3</code></pre></div>   | <div style="width:350px">topic1</div>                                                                                              |
| <div style="width:150px">Group ID</div>          | M                                       | String                                  | <div style="width:400px">A string, that uniquely identifies the consumer group, to which this trigger belongs. Triggers with identical group id would consume messages in parallel.</div>                                                                                                                   | <div style="width:350px">group1</div>                                                                                              |
| <div style="width:150px">SASL Mechanism</div>    | M                                       | List                                    | <div style="width:400px">List with possible SASL Mechanisms. Options are described here: http://www.iana.org/assignments/sasl-mechanisms/sasl-mechanisms.xhtml  </div>                                                                                                                                      | <div style="width:350px">GSSAPI</div>                                                                                              |
| <div style="width:150px">Security Protocol</div> | M                                       | List                                    | <div style="width:400px">Protocol used to communicate with brokers. Possible values:<ul><li>SASL_PLAINTEXT</li><li>PLAINTEXT</li><li>SASL_SSL</li><li>SSL</li></ul></div>                                                                                                                                   | <div style="width:350px">PLAINTEXT</div>                                                                                           |
| <div style="width:150px">SASL JAAS Config</div>  | O                                       | String                                  | <div style="width:400px">Allows to specify Kafka sasl.jaas.config parameter.</div>                                                                                                                                                                                                                          | <div style="width:350px">org.apache.kafka.common.security.plain.PlainLoginModule required username=example password=example;</div> |
| <div style="width:150px">Reconnect delay</div>   | O                                       | String                                  | <div style="width:400px">Delay between reconnection attempts in milliseconds. </div>                                                                                                                                                                                                                        | <div style="width:350px">30000</div>                                                                                               |

- **"MaaS"** connection source type

| Parameter                                            | <div style="width:75px">Mandatory</div> | <div style="width:75px">Data Type</div> | Description                                                                                                                                                                                                                                         | Sample                                                              |
| ---------------------------------------------------- | :-------------------------------------- | :-------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------- |
| <div style="width:150px">Topic Classifier Name</div> | M                                       | String                                  | <div style="width:400px">Specifies the name of the MaaS classifier, that corresponds to topic.</div>                                                                                                                                                | <div style="width:350px">topic1-classifier</div>                    |
| <div style="width:150px">Classifier Namespace</div>  | O                                       | String                                  | <div style="width:400px">Specifies classifier namespace, that shall be used instead of default one. If left empty, default namespace will be utilized. Only works, when MaaS has a security permission rule to access a different namespace. </div> | <div style="width:350px">newNamespace</div>                         |
| <div style="width:150px">Tenant topic enabled</div>  | M                                       | Boolean                                 | <div style="width:400px">Checkbox, that enables "tenantId" field in classifier.<br/> <b>Default value:</b> false</div>                                                                                                                              | <div style="width:350px">false</div>                                |
| <div style="width:150px">Classifier Tenant Id</div>  | C                                       | String                                  | <div style="width:400px">Specifies tenant unique identifier. If not specified, default value will be used. Only works, when "Tenant topic enabled" is "true".</div>                                                                                 | <div style="width:350px">d334cf82-11aa-4vz9-a1a6-ba9f6aa06e09</div> |
| <div style="width:150px">Group ID</div>              | M                                       | String                                  | <div style="width:400px">A string, that uniquely identifies the consumer group, to which this trigger belongs. Triggers with identical group id would consume messages in parallel.</div>                                                           | <div style="width:350px">group1</div>                               |
| <div style="width:150px">Reconnect delay</div>       | O                                       | String                                  | <div style="width:400px">Delay between reconnection attempts in milliseconds. </div>                                                                                                                                                                | <div style="width:350px">30000</div>                                |

#### Advanced Parameters
| Parameter                                                            | <div style="width:75px">Mandatory</div> | <div style="width:75px">Data Type</div> | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | Sample                                                                                  |
| -------------------------------------------------------------------- | :-------------------------------------- | :-------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------- |
| <div style="width:150px">Consumer blue-green consistency mode </div> | M                                       | List                                    | <div style="width:400px">Blue-green specific parameter. Possible values:<li><b>EVENTUAL</b> – consumers offset for candidate during promotion stays the same </li><li><b>GUARANTEE_CONSUMPTION</b> - consumers offset for candidate during promotion is copied from lowest offset for this group of consumers</li><b>Default value: </b>EVENTUAL</div>                                                                                                                             | <div style="width:350px">EVENTUAL</div>                                                 |
| <div style="width:150px">SSL Protocol </div>                         | M                                       | List                                    | <div style="width:400px">The SSL protocol used to generate the SSLContext. Possible values:<li>TLS</li><li>TLSv1.1</li><li>TLSv1.2</li><li>TLSv1.3</li><b>Default value: </b>TLS</div>                                                                                                                                                                                                                                                                                             | <div style="width:350px">TLSv1.2</div>                                                  |
| <div style="width:150px">SSL endpoint algorithm</div>                | O                                       | String                                  | <div style="width:400px">Specifies the endpoint identification algorithm for server hostname validation with server certificate.</div>                                                                                                                                                                                                                                                                                                                                             | <div style="width:350px">HTTPS</div>                                                    |
| <div style="width:150px">Key Deserializer </div>                     | M                                       | List                                    | <div style="width:400px">List with available deserializer classes for keys.<br/><b>Note:</b> it is recommended to use String and ByteArray deserializers when possible. Other options might lead to issues with infinite processing of invalid messages, that might require additional handling logic.</div>                                                                                                                                                                       | <div style="width:350px">org.apache.kafka.common.serialization.StringDeserializer</div> |
| <div style="width:150px">Value Deserializer</div>                    | M                                       | List                                    | <div style="width:400px">List with available deserializer classes for values.<br/><b>Note:</b> it is recommended to use String and ByteArray deserializers when possible. Other options might lead to issues with infinite processing of invalid messages, that might require additional handling logic.</div>                                                                                                                                                                     | <div style="width:350px">org.apache.kafka.common.serialization.StringDeserializer</div> |
| <div style="width:150px">Consumers Count</div>                       | O                                       | Number                                  | <div style="width:400px">Number of consumers.</div>                                                                                                                                                                                                                                                                                                                                                                                                                                | <div style="width:350px">1</div>                                                        |
| <div style="width:150px">Auto Offset Reset</div>                     | M                                       | List                                    | <div style="width:400px">Specifies action for case, when no initial offset exists in Kafka, or current offset does not exist on the server anymore. Possible options: <ul><li>**none** - throw exception to the consumer if no previous offset is found for the consumer's group</li><li>**earliest** - automatically reset the offset to the earliest offset</li><li>**latest** - automatically reset the offset to the latest offset</li></ul><b>Default value: </b>latest</div> | <div style="width:350px">none</div>                                                     |
| <div style="width:150px">maxPollRecords</div>                        | O                                       | Number                                  | <div style="width:400px">The number of records that will be fetched from the broker as a single batch.<br/><b>Default value: </b>500</div>                                                                                                                                                                                                                                                                                                                                         | <div style="width:350px">500</div>                                                      |
| <div style="width:150px">maxPollIntervalMs</div>                     | O                                       | Number                                  | <div style="width:400px">The maximum delay between batch polls of records from the broker, in milliseconds. If poll is not performed within given time frame, then the consumer is considered to be failed. In case of failure detection, related consumer group will re-balance to reassign the partitions to another consumer in the group. <font color="red">This "new" consumer will process the whole batch all over again.</font><br/><b>Default value: </b>300000</div>     | <div style="width:350px">300000</div>                                                   |

#### Metadata
| Parameter                                  | <div style="width:75px">Mandatory</div> | <div style="width:75px">Data Type</div> | Description                                                                               | Sample                                                                                          |
| ------------------------------------------ | :-------------------------------------- | :-------------------------------------- | ----------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------- |
| <div style="width:150px">Name</div>        | M                                       | String                                  | <div style="width:400px">Name of the element.</div>                                       | <div style="width:350px">Kafka Trigger</div>                                                    |
| <div style="width:150px">Description</div> | O                                       | String                                  | <div style="width:400px">Free text field, that contains description of the element.</div> | <div style="width:350px">This element consumes notification messages for the mobile users</div> |

### "Idempotency" Tab
This tab allows setting idempotent behavior in order to avoid processing of the same message by one consumer (especially relevant for Blue-Green deployment approach). The Exchange which has the same idempotency key is regarded as a duplicate. Duplication check is performing on full idempotency key, which has the following structure:
<pre style="background-color: #F5F5F7"><style> .line-numbers-rows { display: none !important; }</style><code style="color: #000000">&lt;idempotency-key&gt; = dupcheck:&lt;context-expression&gt;:&lt;key-expression&gt;</code></pre>

where ```<context-expression>``` and ```<key-expression>``` are fully configurable parts (see the table with parameters description below).

<div style="background-color: #e7f3fe; border-left: 6px solid #2196F3; padding: 10px">The <code>&lt;context-expression&gt;</code> and <code>&lt;key-expression&gt;</code> values can be retrieved via system properties <b><code>systemProperty_idempotencyContext</code></b> and <b><code>systemProperty_idempotencyKey</code></b>, respectively.</div>

The following parameters are available on the tab:
- **Enabled** checkbox - main parameter, which defines whether idempotency will be applied (checked) for trigger or not. Default value: unchecked. If checked, the following set of parameters becomes editable:

| Parameter                                                    | <div style="width:75px">Mandatory</div> | <div style="width:75px">Data Type</div> | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                  | Sample                                                          |
| ------------------------------------------------------------ | :-------------------------------------- | :-------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | --------------------------------------------------------------- |
| <div style="width:150px">Context expression</div>            | М                                       | String                                  | <div style="width:400px">Field should contain some meaningful value that is unique across all the other chains. Supports Camel Simple language. For example you may use: <ul><li><code>\<topic> + \<group id></code></li><li><code>\<classifier> + \<group id></code>, etc.</li></ul></div>                                                                                                                                                                  | <div style="width:350px">topic1-group1</div>                    |
| <div style="width:150px">Key expression</div>                | M                                       | String                                  | <div style="width:400px">Free text field that supports Camel Simple language. Key examples:<ul><li>From message header: <code>${header.header_name}</code></li><li>From message body part: <code>${jq('.field_name')}</code>, <code>${jsonpath('$.field_name')}</code>, <code> ${xpath('/root/field_name/text()')}</code></li></ul></li></ul></div>                                                                                                          | <div style="width:350px"><code>${jsonpath('$.id')}</code></div> |
| <div style="width:150px">Key expiration time (seconds)</div> | O                                       | String                                  | <div style="width:400px">Specifies time in seconds after which idempotency key will be expired<br><b>Default value:</b> 600</div><br><div style="background-color: #e7f3fe; border-left: 6px solid #2196F3; padding: 10px">The Key expiration time (seconds) value can be retrieved via system property <b><code>systemProperty_keyExpiry</code></b></div>                                                                                                   | <div style="width:350px">600</div>                              |
| <div style="width:150px">Action on duplicate</div>           | M                                       | List                                    | <div style="width:400px">Defines action that should be performed in case of key duplication detected. Possible values:<li><i>Ignore</i> - stop session and do not process the call</li><li><i>Throw exception</i> - raise exception and stop call processing</li><li><i>Execute subchain</i> - call selected chain via Chain Trigger. In case this option has been chosen, two more parameters (below in the table) becomes visible and editable.</li></div> | <div style="width:350px">Throw exception</div>                  |
| <div style="width:150px">Chain trigger</div>                 | C                                       | List                                    | <div style="width:400px">Dropdown list, that contains all chains with [Chain Trigger](docs/01__Chains/1__Graph/1__QIP_Elements_Library/6__Triggers/2__Chain_Trigger/chain_trigger.md) elements. Select one which has to be triggered in case of idempotency key duplication.<br><br>Visible only if <b>"Action on duplicate"</b> is <i>"Execute subchain"</i>.</div>                                                                                         | <div style="width:350px">Idempotency handling subchain</div>    |
| <div style="width:150px">Chain call timeout (ms)</div>       | C                                       | String                                  | <div style="width:400px">Timeout in milliseconds for calling the chain with [Chain Trigger](docs/01__Chains/1__Graph/1__QIP_Elements_Library/6__Triggers/2__Chain_Trigger/chain_trigger.md) element. If timeout is reached, session will fail. When left blank, default value will be applied.<br><b>Default value:</b> 600<br><br>Visible only if <b>"Action on duplicate"</b> is <i>"Execute subchain"</i>.</div>                                          | <div style="width:350px">30000</div>                            |

## Constraints

---
Can't set input dependency to element.