# AsyncAPI Trigger
## Description

---
**AsyncAPI Trigger** is an element, that allows to integrate with services, based on **AsyncAPI specifications** and work via **Kafka** or **AMQP**. In order to fulfill its capabilities, this element must be placed at the start of the chain, connected with asynchronous service and properly filled with required integration details, depending on utilized protocol.

<div style="background-color: #e7f3fe; border-left: 6px solid #2196F3; padding: 10px">According to <b>Apache Camel</b> framework, when chain is triggered, system creates <b>Exchange Object</b>, that handles input data following the logic, described in respective article: <a href="doc/00__Overview/2__Apache_Camel_Context_Concept/apache_camel_context_concept.md">Apache Camel Context Concept</a>.
</div>

## User Interface

---
### "Endpoint" Tab

**"Endpoint"** tab is responsible for choosing AsyncAPI specification and it's operations (task). Only services with AsyncAPI specification(s) in **Services** repository are available for selection.

| Parameter                                        | <div style="width:75px">Mandatory</div> | <div style="width:75px">Data Type</div> | Description                                                                                                                                                               | Sample                                              |
| ------------------------------------------------ | :-------------------------------------- | :-------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------- |
| <div style="width:150px">Service</div>           | M                                       | List                                    | <div style="width:400px">List with all asynchronous services, available to be selected. Services without a single API specification won't be presented in the list.</div> | <div style="width:350px">kafka-service-sample</div> |
| <div style="width:150px">API Specification</div> | M                                       | List                                    | <div style="width:400px">List with specifications, grouped by specification groups.</div>                                                                                 | <div style="width:350px">v1.0.0</div>               |
| <div style="width:150px">Operation</div>         | M                                       | List                                    | <div style="width:400px">List with all operations, available for selected API Specification.</div>                                                                        | <div style="width:350px">onTaskStartRefs</div>      |

When service is added, additional section with parameters (based on service type) will appear:

- **Kafka Parameters**

| Parameter                                                    | <div style="width:75px">Mandatory</div> | <div style="width:75px">Data Type</div> | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                      | Sample                                                              |
|--------------------------------------------------------------|:----------------------------------------|:----------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------|
| <div style="width:180px">topic</div>                         | M                                       | String                                  | <div style="width:400px">Kafka topic, from where messages will be consumed.</div>                                                                                                                                                                                                                                                                                                                                                                                | <div style="width:320px">sample-kafka-topic</div>                   |
| <div style="width:180px">groupId</div>                       | O                                       | String                                  | <div style="width:400px">A string, that uniquely identifies the consumer group, to which this trigger belongs. Triggers with identical group id would consume messages in parallel.</div>                                                                                                                                                                                                                                                                        | <div style="width:320px">group1</div>                               |
| <div style="width:180px">maas.classifier.name</div>          | M                                       | String                                  | <div style="width:400px">Specifies the name of the MaaS classifier, that corresponds to topic. </div>                                                                                                                                                                                                                                                                                                                                                            | <div style="width:320px">topic1-classifier</div>                    |
| <div style="width:180px">maas.classifier.namespace</div>     | O                                       | String                                  | <div style="width:400px">Specifies classifier namespace, that shall be used instead of default one. If left empty, default namespace will be utilized. Only works, when MaaS has a security permission rule to access a different namespace.</div>                                                                                                                                                                                                               | <div style="width:320px">newNamespance</div>                        |
| <div style="width:180px">maas.classifier.tenantEnabled</div> | M                                       | String                                  | <div style="width:400px">Enables "tenantId" field in classifier. <br/><b>Default value:</b>false</div>                                                                                                                                                                                                                                                                                                                                                           | <div style="width:320px">false</div>                                |
| <div style="width:180px">maas.classifier.tenantId</div>      | O                                       | String                                  | <div style="width:400px">Specifies tenant unique identifier. If not specified, default value will be used. Only works, when "<b>maas.classifier.tenantEnabled</b>" is "true".</div>                                                                                                                                                                                                                                                                              | <div style="width:320px">d334cf82-11aa-4vz9-a1a6-ba9f6aa06e09</div> |
| <div style="width:180px">consumerConsistencyMode</div>       | M                                       | String                                  | <div style="width:400px">Blue-green specific parameter. Possible values: <ul><li><b>EVENTUAL</b> – Default option when blue-green is supported. Consumers offset for candidate during promotion stays the same </li><li><b>GUARANTEE_CONSUMPTION</b> - consumers offset for candidate during promotion is copied from lowest offset for this group of consumers</li></ul> <b>Note:</b>This parameter and its value should be entered manually if required.</div> | <div style="width:320px">EVENTUAL</div>                             |

<div style="background-color: #e7f3fe; border-left: 6px solid #2196F3; padding: 10px">
<b>Note:</b><br>
When message processing is slow, it could lead to <font color="red">interruptions</font> and other negative effects, such as <font color="red">repeated message processing</font> from the topic. In such cases, it must be considered to:
<ul>
<li>Increase value for parameter <b>maxPollIntervalMs</b>, responsible for the maximum delay between invocations of polls when using consumer group management. Default is <b>300000</b> ms.</li>
<li>Decrease value for parameter <b>maxPollRecords</b>, responsible for the maximum number of records returned in a single call to poll. Default is <b>500</b>.</li></ul>
This will allow to process the messages smoothly, with lower risk of reaching the timeout.
</div>


- **RabbitMQ Parameters**

| Parameter                                                | <div style="width:75px">Mandatory</div> | <div style="width:75px">Data Type</div> | Description                                                                                                                                                                                                                                        | Sample                                             |
| -------------------------------------------------------- | :-------------------------------------- | :-------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------- |
| <div style="width:150px">exchangeName </div>             | M                                       | String                                  | <div style="width:400px">The exchange name determines the exchange, messages will be consumed from. </div>                                                                                                                                         | <div style="width:350px">sample-exchange-v1 </div> |
| <div style="width:150px">queues </div>                   | M                                       | String                                  | <div style="width:400px">Name of the queue(s), from where trigger will consume messages. Use comma as a separator when specifying multiple queues.</div>                                                                                           | <div style="width:350px">qip-maas-queue-1 </div>   |
| <div style="width:150px">maas.classifier.name </div>     | M                                       | String                                  | <div style="width:400px">Vhost classifier name. Parameter is only available for MaaS connection type.</br> **Default value:** public  </div>                                                                                                       | <div style="width:350px">public </div>             |
| <div style="width:150px">maas.classifier.namespace</div> | O                                       | String                                  | <div style="width:400px">Specifies classifier namespace, that shall be used instead of default one. If left empty, default namespace will be utilized. Only works, when MaaS has a security permission rule to access a different namespace.</div> | <div style="width:350px">newNamespance</div>       |
| <div style="width:150px">routingKey</div>                | O                                       | String                                  | <div style="width:400px">The routing key to use when binding a consumer queue to the exchange.</div>                                                                                                                                               | <div style="width:350px">rkey-1 </div>             |

### "Validate Request" Tab

The tab **"Validate request"** is responsible for choosing JSON schema for message validation. Click "**Add**" button, select message type and click "**Create**" to add validation.

### "Filter Request" Tab

On this tab, you could add headers into the **"Header whitelist"** table to avoid processing of incoming messages that have headers with  values, that do not correspond to the table, or have no mentioned headers at all.
To add a header, simply click **"Add"** button, then specify header's name and value. Keep the table blank if no filter logic required.

### "Idempotency" Tab
This tab allows setting idempotent behavior in order to avoid processing of the same message by one consumer (especially relevant for Blue-Green deployment approach). The Exchange which has the same idempotency key is regarded as a duplicate. Duplication check is performing on full idempotency key, which has the following structure:
<pre style="background-color: #F5F5F7"><style> .line-numbers-rows { display: none !important; }</style><code style="color: #000000">&lt;idempotency-key&gt; = dupcheck:&lt;context-expression&gt;:&lt;key-expression&gt;</code></pre>

where ```<context-expression>``` and ```<key-expression>``` are fully configurable parts (see the table with parameters description below).

<div style="background-color: #e7f3fe; border-left: 6px solid #2196F3; padding: 10px">The <code>&lt;context-expression&gt;</code> and <code>&lt;key-expression&gt;</code> values can be retrieved via system properties <b><code>systemProperty_idempotencyContext</code></b> and <b><code>systemProperty_idempotencyKey</code></b>, respectively.</div>

The following parameters are available on the tab:
- **Enabled** checkbox - main parameter, which defines whether idempotency will be applied (checked) for trigger or not. Default value: unchecked. If checked, the following set of parameters becomes editable:

| Parameter                                                    | <div style="width:75px">Mandatory</div> | <div style="width:75px">Data Type</div> | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                  | Sample                                                          |
| ------------------------------------------------------------ | :-------------------------------------- | :-------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | --------------------------------------------------------------- |
| <div style="width:150px">Context expression</div>            | М                                       | String                                  | <div style="width:400px">Field should contain some meaningful value that is unique across all the other chains. Supports Camel Simple language. For example in case of Kafka service you may use: <ul><li><code>\<topic> + \<group id></code></li><li><code>\<classifier> + \<group id></code>, etc.</li></ul>In case of RabbitMQ service:<ul><li><code>\<queue></code></li><li><code>\<classifier> + \<queue></code>, etc.</li></ul></div>                  | <div style="width:350px">topic1-group1</div>                    |
| <div style="width:150px">Key expression</div>                | M                                       | String                                  | <div style="width:400px">Free text field that supports Camel Simple language. Key examples:<ul><li>From message header: <code>${header.header_name}</code></li><li>From message body part: <code>${jq('.field_name')}</code>, <code>${jsonpath('$.field_name')}</code>, <code> ${xpath('/root/field_name/text()')}</code></li></ul></li></ul></div>                                                                                                          | <div style="width:350px"><code>${jsonpath('$.id')}</code></div> |
| <div style="width:150px">Key expiration time (seconds)</div> | O                                       | String                                  | <div style="width:400px">Specifies time in seconds after which idempotency key will be expired<br><b>Default value:</b> 600 <br/><br/><div style="background-color: #e7f3fe; border-left: 6px solid #2196F3; padding: 10px">The Key expiration time (seconds) value can be retrieved via system property <b><code>systemProperty_keyExpiry</code></b>.</div></div>                                                                                           | <div style="width:350px">600</div>                              |
| <div style="width:150px">Action on duplicate</div>           | M                                       | List                                    | <div style="width:400px">Defines action that should be performed in case of key duplication detected. Possible values:<li><i>Ignore</i> - stop session and do not process the call</li><li><i>Throw exception</i> - raise exception and stop call processing</li><li><i>Execute subchain</i> - call selected chain via Chain Trigger. In case this option has been chosen, two more parameters (below in the table) becomes visible and editable.</li></div> | <div style="width:350px">Throw exception</div>                  |
| <div style="width:150px">Chain trigger</div>                 | C                                       | List                                    | <div style="width:400px">Dropdown list, that contains all chains with [Chain Trigger](docs/01__Chains/1__Graph/1__QIP_Elements_Library/6__Triggers/2__Chain_Trigger/chain_trigger.md) elements. Select one which has to be triggered in case of idempotency key duplication.<br><br>Visible only if <b>"Action on duplicate"</b> is <i>"Execute subchain"</i>.</div>                                                                                         | <div style="width:350px">Idempotency handling subchain</div>    |
| <div style="width:150px">Chain call timeout (ms)</div>       | C                                       | String                                  | <div style="width:400px">Timeout in milliseconds for calling the chain with [Chain Trigger](docs/01__Chains/1__Graph/1__QIP_Elements_Library/6__Triggers/2__Chain_Trigger/chain_trigger.md) element. If timeout is reached, session will fail. When left blank, default value will be applied.<br><b>Default value:</b> 600<br><br>Visible only if <b>"Action on duplicate"</b> is <i>"Execute subchain"</i>.</div>                                          | <div style="width:350px">30000</div>                            |

### "Parameters" Tab
#### Common Parameters
| Parameter                                      | <div style="width:75px">Mandatory</div>   | <div style="width:75px">Data Type</div>   | Description                                                                          | Sample                                |
|------------------------------------------------|:------------------------------------------|:------------------------------------------|--------------------------------------------------------------------------------------|---------------------------------------|
| <div style="width:150px">Reconnect delay</div> | O                                         | Number                                    | <div style="width:400px">Specifies delay between reconnection in milliseconds.</div> | <div style="width:350px">30000</div>  |

#### Metadata
| Parameter                                  | <div style="width:75px">Mandatory</div> | <div style="width:75px">Data Type</div> | Description                                                                               | Sample                                                                 |
| ------------------------------------------ | :-------------------------------------- | :-------------------------------------- | ----------------------------------------------------------------------------------------- | ---------------------------------------------------------------------- |
| <div style="width:150px">Name</div>        | M                                       | String                                  | <div style="width:400px">Name of the element.</div>                                       | <div style="width:350px">AsyncAPI Trigger</div>                        |
| <div style="width:150px">Description</div> | O                                       | String                                  | <div style="width:400px">Free text field, that contains description of the element.</div> | <div style="width:350px">Subscribed to message queue to get info</div> |

## Constraints

---
Please consider next constraints:
- Only one validation can be applied. Button "**Add**" will be disabled on "**Validate Request**" tab if at least one validation is already added.
- Common Apache Camel Kafka parameters "resumeStrategy", "seekTo", "offsetRepository", "allowManualCommit", "autoCommitEnable", "kafkaManualCommitFactory" are not fully supported and shall not be specified for Kafka type of trigger. If specified - issue will be presented during the chain deployment.
- **AsyncAPI Trigger** with **Kafka** type will always operate with next default settings for common Apache Camel Kafka parameters: "autoCommitOnStop"  = "sync", "allowManualCommit" = "false", "autoCommitEnable" = "true".
- Can't set input dependency to element.