# HTTP Trigger
## Description

---
**HTTP Trigger** allows to expose the Chain via **HTTP** by unique **URI** and **method**. Depending on the configured settings, URI can be accessed via external, internal or public routes.

<div style="background-color: #e7f3fe; border-left: 6px solid #2196F3; padding: 10px">According to <b>Apache Camel</b> framework, when chain is triggered, system creates <b>Exchange Object</b>, that handles input data following the logic, described in respective article: <a href="doc/00__Overview/2__Apache_Camel_Context_Concept/apache_camel_context_concept.md">Apache Camel Context Concept</a>.</div>


## User Interface

---
### "Endpoint" Tab
On this tab user can set the endpoint parameters by which chain could be triggered. There are two options to define it:

- **"Custom"** URI source<br>
  Custom URI source allows to define your own unique endpoint.

| Parameter                                   | <div style="width:75px">Mandatory</div> | <div style="width:75px">Data Type</div> | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | Sample                                                                                                                                                                                                                                                                                                                                                                                                     |
| ------------------------------------------- | :-------------------------------------- | :-------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| <div style="width:150px">URI</div>          | M                                       | String                                  | <div style="width:400px">URI of the HTTP resource which will be used to trigger further data processing.<ul><li>When checkbox <b>"External route"</b> is marked, then deployed chain can be triggered by the endpoint below:</li><pre style="background-color: #F5F5F7"><code style="color: #000000">https://public-gateway-{{namespace}}.{{environment}}/qip-routes/{{specified uri}}</code></pre></li><li>When checkbox <b>"Private route"</b> is marked, then deployed chain can be triggered by the endpoint below:</li><pre style="background-color: #F5F5F7"><code style="color: #000000">https://private-gateway-{{namespace}}.{{environment}}/qip-routes/{{specified uri}}</code></pre></li><li>In any case, deployed chain could always be triggered by the next endpoint <b>within the current K8S network</b> (usually, used by other pods via M2M communication pattern):</li><pre style="background-color: #F5F5F7"><code style="color: #000000">http://qubership-integration-platform-engine:8080/routes/{{specified uri}}</code></pre></li></ul>Design time variable, which is configured on Admin Tools tab could be also used to build URI. Variable shall be set, following system's syntax <b>#{variable name}</b>. </div> | <div style="width:350px">External/Private route:<br/><pre style="background-color: #F5F5F7"><code style="color: #000000">/qip-routes/myChain</code></pre>Common route:<br/><pre style="background-color: #F5F5F7"><code style="color: #000000">/routes/myChain</code></pre>Route with variable:<br/><pre style="background-color: #F5F5F7"><code style="color: #000000">/routes/#{var1}</code></pre></div> |
| <div style="width:150px">HTTP Methods</div> | O                                       | List                                    | <div style="width:400px">List of all available HTTP methods, that could trigger the chain:<ul><li>GET</li><li>POST</li><li>PUT</li><li>PATCH</li><li>DELETE</li><li>HEAD</li><li>OPTIONS</ul>When not a single method is selected, then all methods are considered to be applicable for trigger the chain.</div>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | <div style="width:350px">GET </div>                                                                                                                                                                                                                                                                                                                                                                        |

- **"Implemented Service"** URI source<br>
  Implemented Service URI source allows using existing endpoint from implemented service.

| Parameter                                        | <div style="width:75px">Mandatory</div> | <div style="width:75px">Data Type</div> | Description                                                                                                                                            | Sample                                                                                                |
| ------------------------------------------------ | :-------------------------------------- | :-------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------ | ----------------------------------------------------------------------------------------------------- |
| <div style="width:150px">Service</div>           | M                                       | List                                    | <div style="width:400px">List, that contains implemented services, available for selection. Only services with API Specifications are available.</div> | <div style="width:350px">Entry point of the chain</div>                                               |
| <div style="width:150px">API Specification</div> | M                                       | List                                    | <div style="width:400px">List with specifications, grouped by specification groups.</div>                                                              | <div style="width:350px">Trigger for mobile application for getting info about customer account</div> |
| <div style="width:150px">Operation</div>         | M                                       | List                                    | <div style="width:400px">List with all operations, available for selected API Specification.</div>                                                     | <div style="width:350px">POST /createPet </div>                                                       |
| <div style="width:150px">Base path</div>         | M                                       | String                                  | <div style="width:400px">Automatically built base path for the endpoint. Non-editable parameter.</div>                                                 | <div style="width:350px">/qip-routes </div>                                                           |

### "Validate request" Tab
The tab "Validate request" is responsible for choosing JSON schema for incoming request message validation. There are next elements available on this tab:
- **Reject request if body is not empty for GET and DELETE methods** checkbox - if checked, system will handle missing body in the request of mentioned methods as validation failure.
- **Allowed Content Types** - list of allowed content types in request. If nothing is specified - every content type is allowed.
- **Scheme** box - allows to enter a scheme to validate the request against it.

### "Handle Validation Failure" Tab
This tab is specifically designed to control validation message format, that will be returned in case of validation failure. There are three options of handling, presented as values for "**Actions**" list:
- **Default** - default message will be presented in the response, when validation fails.
- **Mapper** - system will show mapper interface with default schema, so it is possible to build custom message.
- **Scripting** - system presents script box for custom message building.

### "Failure Response Mapping" Tab
This tab allows to set up global failure handling for whole chain. Errors, that are not handled via "**Handle Validation Failure**" tab or within chains via [Try-Catch-Finally](docs/01__Chains/1__Graph/1__QIP_Elements_Library/1__Routing/9__Try-Catch-Finally/try-catch-finally.md) or similar mechanism, available for other elements under their specialized tabs, are going to be processed according to the selected option:
- **Default** - default message will be presented in the response, when chain fails.
- **Mapper** - custom error message can be settled via mapper instrument.
- **Scripting** - chain failure is handled by the entered script.
- **Sub-Chain** - when failure is caused, system triggers linked sub-chain.

### "Idempotency" Tab
This tab allows setting idempotent behavior in order to avoid processing of the same message by one consumer. The Exchange which has the same idempotency key is regarded as a duplicate. Duplication check is performing on full idempotency key, which has the following structure:
<pre style="background-color: #F5F5F7"><style> .line-numbers-rows { display: none !important; }</style><code style="color: #000000">&lt;idempotency-key&gt; = dupcheck:&lt;context-expression&gt;:&lt;key-expression&gt;</code></pre>

where ```<context-expression>``` and ```<key-expression>``` are fully configurable parts (see the table with parameters description below).

<div style="background-color: #e7f3fe; border-left: 6px solid #2196F3; padding: 10px">The <code>&lt;context-expression&gt;</code> and <code>&lt;key-expression&gt;</code> values can be retrieved via system properties <b><code>systemProperty_idempotencyContext</code></b> and <b><code>systemProperty_idempotencyKey</code></b>, respectively.</div>

The following parameters are available on the tab:
- **Enabled** checkbox - main parameter, which defines whether idempotency will be applied (checked) for trigger or not. Default value: unchecked. If checked, the following set of parameters becomes editable:

| Parameter                                                    | <div style="width:75px">Mandatory</div> | <div style="width:75px">Data Type</div> | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | Sample                                                          |
| ------------------------------------------------------------ | :-------------------------------------- | :-------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------- |
| <div style="width:150px">Key expiration time (seconds)</div> | O                                       | String                                  | <div style="width:400px">Specifies time in seconds after which idempotency key will be expired<br><b>Default value:</b> 600</div><br><div style="background-color: #e7f3fe; border-left: 6px solid #2196F3; padding: 10px">The Key expiration time (seconds) value can be retrieved via system property <b><code>systemProperty_keyExpiry</code></b></div>                                                                                                                              | <div style="width:350px">600</div>                              |
| <div style="width:150px">Context expression</div>            | лю                                       | String                                  | <div style="width:400px">Field should contain some meaningful value that is unique across all the other chains. Supports Camel Simple language. For example you may use: <code>\<HTTP Method> + \<path></code></div>                                                                                                                                                                                                                                                                    | <div style="width:350px">GET /routes/myChain</div>              |
| <div style="width:150px">Key expression</div>                | M                                       | String                                  | <div style="width:400px">Free text field that supports Camel Simple language. Key examples:<ul><li>From message header: <code>${header.header_name}</code></li><li>From message body part: <code>${jq('.field_name')}</code>, <code>${jsonpath('$.field_name')}</code>, <code> ${xpath('/root/field_name/text()')}</code></li></ul></li></ul></div>                                                                                                                                     | <div style="width:350px"><code>${jsonpath('$.id')}</code></div> |
| <div style="width:150px">Action on duplicate</div>           | M                                       | List                                    | <div style="width:400px">Defines action that should be performed in case of key duplication detected. Possible values:<li><i>Return 202</i> - respond with 202 Accepted HTTP code and do not process the call</li><li><i>Throw exception</i> - raise exception and stop call processing</li><li><i>Execute subchain</i> - call selected chain via Chain Trigger. In case this option has been chosen, two more parameters (below in the table) becomes visible and editable.</li></div> | <div style="width:350px">Throw exception</div>                  |
| <div style="width:150px">Chain trigger</div>                 | C                                       | List                                    | <div style="width:400px">Dropdown list, that contains all chains with [Chain Trigger](docs/01__Chains/1__Graph/1__QIP_Elements_Library/6__Triggers/2__Chain_Trigger/chain_trigger.md) elements. Select one which has to be triggered in case of idempotency key duplication.<br><br>Visible only if <b>"Action on duplicate"</b> is <i>"Execute subchain"</i>.</div>                                                                                                                    | <div style="width:350px">Idempotency handling subchain</div>    |
| <div style="width:150px">Chain call timeout (ms)</div>       | C                                       | String                                  | <div style="width:400px">Timeout in milliseconds for calling the chain with [Chain Trigger](docs/01__Chains/1__Graph/1__QIP_Elements_Library/6__Triggers/2__Chain_Trigger/chain_trigger.md) element. If timeout is reached, session will fail. When left blank, default value will be applied.<br><b>Default value:</b> 600<br><br>Visible only if <b>"Action on duplicate"</b> is <i>"Execute subchain"</i>.</div>                                                                     | <div style="width:350px">30000</div>                            |

### "Parameters" Tab
#### Common Parameters

This section allows to configure access validation via next "Access Control Type" options:

- **"RBAC"**: role-based access control option, where access is controlled by roles, specified in the list.

| Parameter                            | <div style="width:75px">Mandatory</div> | <div style="width:75px">Data Type</div>        | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | Sample                                        |
| ------------------------------------ | :-------------------------------------- | :--------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------- |
| <div style="width:150px">Roles</div> | M                                       | <div style="width:75px">Array of Strings</div> | <div style="width:400px">Parameter to define unlimited array of user roles, permitted to trigger the chain. In case of permission denial, system returns <b>403 Forbidden</b> response code without even starting a session. This field also accepts references to design time variables (e.g. <i>#{var_name}</i>).<br><br><div style="background-color: #e7f3fe; border-left: 6px solid #2196F3; padding: 10px"><b>Note:</b><br>Switching to a different Access Control type (ABAC/NONE) will clear entered list of roles.</div></div> | <div style="width:350px">TEST_USER_ROLE</div> |

- **"ABAC"**: - attribute-based access control option, where access is controlled by policies, stored in Access Control service (policies are linked with exact chain by described below set of parameters).

| Parameter                                         | <div style="width:75px">Mandatory</div> | <div style="width:75px">Data Type</div>  | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | Sample                                                                                                                                |
| ------------------------------------------------- | :-------------------------------------- | :--------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------- |
| <div style="width:150px">Resource Type</div>      | M                                       | <div style="width:75px">String</div>     | <div style="width:400px">Resource type specifies the category or type of resource being accessed. This is used to apply policies based on what type of object is being targeted.<br> **Default:** QIP-CHAIN </div><br><br><br>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | <div style="width:350px">Customer</div>                                                                                               |
| <div style="width:150px">Operation</div>          | M                                       | <div style="width:75px">String</div>     | <div style="width:400px">Operation defines the action being attempted on the selected resource. <br> **Default:** ALL </div>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | <div style="width:350px">LIST</div>                                                                                                   |
| <div style="width:150px">Resource Data Type</div> | M                                       | <div style="width:75px">List</div>       | <div style="width:400px">Identifies the data type to be used for the selected resource. User can select option depending upon the values that are used to represent the attributes. Possible data types:<br><ul><li>String (default) - can be selected when single value is enough to represent the attribute.</li><li>Map - can be selected when multiple related attributes are used to represent a single field, or when complex matching logic is required in ABAC policies.</li></div>                                                                                                                                                                                                                                                                                                                                                                                        | <div style="width:350px">String</div>                                                                                                 |
| <div style="width:150px">Resource </div>          | M                                       | <div style="width:75px">String/Map</div> | <div style="width:400px">Resource identifier, that shall be specified in order to perform user access validations against policies, stored in Access Control. If such option is selected, chain will be only triggered, if Access Control confirms, that user is actually allowed to utilize the resource its calling. **_403 Forbidden_** code will be returned if access is denied. This field also accepts references to design time and runtime variables (e.g. <i>#{variable_name} or ${exchangeProperty.variables["variable_name"]}).</i>).<br/><br> **Default:** in case of "String" resource data type takes HTTP URI value by default from 'Endpoint' tab. <br><br><div style="background-color: #e7f3fe; border-left: 6px solid #2196F3; padding: 10px"><b>Note:</b><br>Policies shall be manually configured for given resource in Access Control directly.</div></div> | String:<br>/qip-routes/v1/customer<br><br>Map:<br>path: "/qip-routes/v1/customer"<br>customerId: ${header.CustomerID}<br><br><br><br> |

<div style="background-color: #e7f3fe; border-left: 6px solid #2196F3; padding: 10px"><b>Note:</b><br>Switching to a different Access Control type restores default ABAC parameter values.</div>

- **"NONE" (default):** disables access control option. No additional config fields should be visible for this option.

#### Advanced Parameters
| Parameter                                                              | <div style="width:75px">Mandatory</div> | <div style="width:75px">Data Type</div> | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | Sample                                          |
| ---------------------------------------------------------------------- | :-------------------------------------- | :-------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------- |
| <div style="width:150px">Chunked</div>                                 | M                                       | Boolean                                 | <div style="width:400px">Checkbox. If this option is unchecked the Servlet will disable the HTTP streaming and set the content-length header on the response.</div>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | <div style="width:350px">N/A </div>             |
| <div style="width:150px">Private route</div>                           | M                                       | Boolean                                 | <div style="width:400px">Checkbox. If checked - HTTP trigger will be registered on Private Gateway. Checkbox is inactive when registration is turned off by global environment settings. </div>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | <div style="width:350px">N/A</div>              |
| <div style="width:150px">Response filter</div>                         | M                                       | Boolean                                 | <div style="width:400px">Checkbox. Turns on ability to handle additional query parameters "fields" and "excludeFields" to include only specific fields in response or exclude them from there. This is only supported for responses in JSON. Filter key for mentioned parameters **must not** contain "/", ",", "." symbols.<br/>Please see usage examples below for common cases:<ul><li>Remove "name" field from response:</li><pre style="background-color: #F5F5F7"><code style="color: #000000">https://.../qip-routes/{{specified uri}}&excludeFields=name</code></pre><li>Remove "name" and "age" fields from response:</li><pre style="background-color: #F5F5F7"><code style="color: #000000">https://.../qip-routes/{{specified uri}}&excludeFields=name,age</code></pre><li>Return only one nested field "name", placed under "customer" object:</li><pre style="background-color: #F5F5F7"><code style="color: #000000">https://.../qip-routes/{{specified uri}}&fields=customer.name</code></pre><li>Return object "customer" but remove field "name" from this object in response:</li><pre style="background-color: #F5F5F7"><code style="color: #000000">https://.../qip-routes/{{specified uri}}&fields=customer&excludeFields=customer.name</code></pre></ul></div> | <div style="width:350px">N/A</div>              |
| <div style="width:150px">Connection timeout</div>                      | O                                       | String                                  | <div style="width:400px">Specifies connection timeout in milliseconds.<br/><b>Default:</b> 120000 </div>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | <div style="width:350px">120000</div>           |
| <div style="width:150px">Terminate session on connection timeout</div> | M                                       | Boolean                                 | <div style="width:400px">Checkbox. If this option is checked, session will be terminated right on connection timeout and might not be finished.<br/><b>Default:</b> unchecked </div>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | <div style="width:350px">N/A</div>              |
| <div style="width:150px">Receive correlation id</div>                  | M                                       | Boolean                                 | <div style="width:400px">Checkbox, that enables ability to define correlation id.</div>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | <div style="width:350px">N/A </div>             |
| <div style="width:150px">External route</div>                          | M                                       | Boolean                                 | <div style="width:400px">Checkbox. If checked - HTTP trigger will be registered on Public Gateway. Checkbox is inactive when registration is turned off by global environment settings. </div>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | <div style="width:350px">N/A</div>              |
| <div style="width:150px">Correlation Id Position</div>                 | C                                       | List                                    | <div style="width:400px">Position of correlation id in request. Possible values:<li>Header</li><li>Body</li> Visible if <b>"Receive correlation id"</b> checkbox is marked.</div>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | <div style="width:350px">Header</div>           |
| <div style="width:150px">Correlation Id Key</div>                      | C                                       | String                                  | <div style="width:400px">The exact name of the header or body parameter, that holds correlation id value.</div>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | <div style="width:350px">correlationIdKey</div> |


#### Metadata
| Parameter                                  | <div style="width:75px">Mandatory</div> | <div style="width:75px">Data Type</div> | Description                                                                               | Sample                                                            |
| ------------------------------------------ | :-------------------------------------- | :-------------------------------------- | ----------------------------------------------------------------------------------------- | ----------------------------------------------------------------- |
| <div style="width:150px">Name</div>        | M                                       | String                                  | <div style="width:400px">Name of the element.</div>                                       | <div style="width:350px">HTTP Trigger</div>                       |
| <div style="width:150px">Description</div> | O                                       | String                                  | <div style="width:400px">Free text field, that contains description of the element.</div> | <div style="width:350px">Triggers the chain by HTTP request</div> |

## Constraints

---
Can't set input dependency to element.
