# PubSub Trigger

## Description

---
**Google PubSub** element allows to integrate the chain with **Cloud Pub/Sub Infrastructure** via utilizing **Google Cloud Java Client** and read the messages from the specified topic.

<div style="background-color: #e7f3fe; border-left: 6px solid #2196F3; padding: 10px">According to <b>Apache Camel</b> framework, when chain is triggered, system creates <b>Exchange Object</b>, that handles input data following the logic, described in respective article: <a href="doc/00__Overview/2__Apache_Camel_Context_Concept/apache_camel_context_concept.md">Apache Camel Context Concept</a>.</div>

## User Interface

---
### "Parameters" Tab
#### Common Parameters

| Parameter                                          | <div style="width:75px">Mandatory</div> | <div style="width:75px">Data Type</div> | Description                                                                                                                                                                                                                                                                                                       | Sample                                          |
| -------------------------------------------------- | --------------------------------------- | --------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------- |
| <div style="width:150px">Project id</div>          | M                                       | String                                  | <div style="width:400px">Google Cloud PubSub Project Identifier.</div>                                                                                                                                                                                                                                            | <div style="width:350px">sandbox</div>          |
| <div style="width:150px">Destination name</div>    | M                                       | String                                  | <div style="width:400px">Specifies the name of the source subscription.</div>                                                                                                                                                                                                                                     | <div style="width:350px">subscriptionName</div> |
| <div style="width:150px">Service account key</div> | M                                       | String                                  | <div style="width:400px">Specifies service account key, that can be used as credentials for the PubSub publisher.<br/> <div style="background-color: #e7f3fe; border-left: 6px solid #2196F3; padding: 10px"><b>Note:</b><br>Value for this parameter must be presented as encoded base64 json file.</div> </div> | <div style="width:350px">#{pubsub_key}</div>    |


#### Advanced Parameters

| Parameter                                               | <div style="width:75px">Mandatory</div> | <div style="width:75px">Data Type</div> | Description                                                                                                                                                                                                                                                                                                                                                                                      | Sample                                     |
|---------------------------------------------------------|-----------------------------------------|-----------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------|
| <div style="width:150px">Max ack extension period</div> | O                                       | String                                  | <div style="width:400px">Set the maximum period in seconds a message ack deadline will be extended. If not specified, default value is utilized.<br/><b>Default: </b>3600</div>                                                                                                                                                                                                                  | <div style="width:350px">3600</div>        |
| <div style="width:150px">Max messages per poll</div>    | O                                       | String                                  | <div style="width:400px">Specifies the maximum number of messages to receive from the server in a single poll.<br/><b>Default: </b>1</div>                                                                                                                                                                                                                                                       | <div style="width:350px">1</div>           |
| <div style="width:150px">Retryable error codes</div>    | M                                       | List                                    | <div style="width:400px">Comma-separated list of error codes for synchronous pull, that could be retried. If not specified, default value is utilized. Possible values: Possible values:<ul><li>ABORTED</li><li>CANCELLED</li><li>DEADLINE_EXCEEDED</li><li>INTERNAL</li><li>RESOURCE_EXHAUSTED</li><li>UNKNOWN</li><li>UNAVAILABLE</li></ul><b>Default: </b>ABORTED, UNAVAILABLE, UNKNOWN</div> | <div style="width:350px">UNAVAILABLE</div> |
| <div style="width:150px">Ack mode</div>                 | M                                       | List                                    | <div style="width:400px">Possible values:<ul><li>AUTO  - Exchange gets ack’ed/nack’ed on completion.</li><li>NONE - Downstream process has to ack/nack explicitly.</li></ul><b>Default: </b>AUTO</div>                                                                                                                                                                                           | <div style="width:350px">AUTO</div>        |

#### Metadata

| Parameter                                  | <div style="width:75px">Mandatory</div>  | <div style="width:75px">Data Type</div>  | Description                                                                                | Sample                                                                                    |
|--------------------------------------------|:-----------------------------------------|:-----------------------------------------|--------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------|
| <div style="width:150px">Name</div>        | M                                        | String                                   | <div style="width:400px">Name of the element.</div>                                        | <div style="width:350px">PubSub Trigger</div>                                             |
| <div style="width:150px">Description</div> | O                                        | String                                   | <div style="width:400px">Free text field, that contains description of the element.</div>  | <div style="width:350px">Triggers the chain when message is received from the topic</div> |

### "Idempotency" Tab
This tab allows setting idempotent behavior in order to avoid processing of the same message by one consumer (especially relevant for Blue-Green deployment approach). The Exchange which has the same idempotency key is regarded as a duplicate. Duplication check is performing on full idempotency key, which has the following structure:
<pre style="background-color: #F5F5F7"><style> .line-numbers-rows { display: none !important; }</style><code style="color: #000000">&lt;idempotency-key&gt; = dupcheck:&lt;context-expression&gt;:&lt;key-expression&gt;</code></pre>

where ```<context-expression>``` and ```<key-expression>``` are fully configurable parts (see the table with parameters description below).

<div style="background-color: #e7f3fe; border-left: 6px solid #2196F3; padding: 10px">The <code>&lt;context-expression&gt;</code> and <code>&lt;key-expression&gt;</code> values can be retrieved via system properties <b><code>systemProperty_idempotencyContext</code></b> and <b><code>systemProperty_idempotencyKey</code></b>, respectively.</div>

The following parameters are available on the tab:
- **Enabled** checkbox - main parameter, which defines whether idempotency will be applied (checked) for trigger or not. Default value: unchecked. If checked, the following set of parameters becomes editable:

| Parameter                                                    | <div style="width:75px">Mandatory</div> | <div style="width:75px">Data Type</div> | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                  | Sample                                                          |
| ------------------------------------------------------------ | :-------------------------------------- | :-------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | --------------------------------------------------------------- |
| <div style="width:150px">Context expression</div>            | М                                       | String                                  | <div style="width:400px">Field should contain some meaningful value that is unique across all the other chains. Supports Camel Simple language. For example you may use: <code>\<project-id> + \<destination name></code></div>                                                                                                                                                                                                                              | <div style="width:350px">sandbox-subscriptionName</div>         |
| <div style="width:150px">Key expression</div>                | M                                       | String                                  | <div style="width:400px">Free text field that supports Camel Simple language. Key examples:<ul><li>From message header: <code>${header.header_name}</code></li><li>From message body part: <code>${jq('.field_name')}</code>, <code>${jsonpath('$.field_name')}</code>, <code> ${xpath('/root/field_name/text()')}</code></li></ul></li></ul></div>                                                                                                          | <div style="width:350px"><code>${jsonpath('$.id')}</code></div> |
| <div style="width:150px">Key expiration time (seconds)</div> | O                                       | String                                  | <div style="width:400px">Specifies time in seconds after which idempotency key will be expired<br><b>Default value:</b> 600</div><br><div style="background-color: #e7f3fe; border-left: 6px solid #2196F3; padding: 10px">The Key expiration time (seconds) value can be retrieved via system property <b><code>systemProperty_keyExpiry</code></b></div>                                                                                                   | <div style="width:350px">600</div>                              |
| <div style="width:150px">Action on duplicate</div>           | M                                       | List                                    | <div style="width:400px">Defines action that should be performed in case of key duplication detected. Possible values:<li><i>Ignore</i> - stop session and do not process the call</li><li><i>Throw exception</i> - raise exception and stop call processing</li><li><i>Execute subchain</i> - call selected chain via Chain Trigger. In case this option has been chosen, two more parameters (below in the table) becomes visible and editable.</li></div> | <div style="width:350px">Throw exception</div>                  |
| <div style="width:150px">Chain trigger</div>                 | C                                       | List                                    | <div style="width:400px">Dropdown list, that contains all chains with [Chain Trigger](docs/01__Chains/1__Graph/1__QIP_Elements_Library/6__Triggers/2__Chain_Trigger/chain_trigger.md) elements. Select one which has to be triggered in case of idempotency key duplication.<br><br>Visible only if <b>"Action on duplicate"</b> is <i>"Execute subchain"</i>.</div>                                                                                         | <div style="width:350px">Idempotency handling subchain</div>    |
| <div style="width:150px">Chain call timeout (ms)</div>       | C                                       | String                                  | <div style="width:400px">Timeout in milliseconds for calling the chain with [Chain Trigger](docs/01__Chains/1__Graph/1__QIP_Elements_Library/6__Triggers/2__Chain_Trigger/chain_trigger.md) element. If timeout is reached, session will fail. When left blank, default value will be applied.<br><b>Default value:</b> 600<br><br>Visible only if <b>"Action on duplicate"</b> is <i>"Execute subchain"</i>.</div>                                          | <div style="width:350px">30000</div>                            |

## Constraints

---
There are no specific constraints for the element.