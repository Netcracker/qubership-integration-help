# RabbitMQ Trigger
## Description

---
**RabbitMQ Trigger** element allows to integrate the chain with RabbitMQ instance and setup messages consumption from specific queue and exchange.

<div style="background-color: #e7f3fe; border-left: 6px solid #2196F3; padding: 10px">According to <b>Apache Camel</b> framework, when chain is triggered, system creates <b>Exchange Object</b>, that handles input data following the logic, described in respective article: <a href="doc/00__Overview/2__Apache_Camel_Context_Concept/apache_camel_context_concept.md">Apache Camel Context Concept</a>.</div>

## User Interface

---
### "Parameters" Tab
#### Common Parameters

- **"Manual"** connection source type

| Parameter                                    | <div style="width:75px">Mandatory</div> | <div style="width:75px">Data Type</div> | Description                                                                                                                                                                                            | Sample                                         |
| -------------------------------------------- | :-------------------------------------- | :-------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ---------------------------------------------- |
| <div style="width:150px">Queue(s) Name</div> | M                                       | String                                  | <div style="width:400px">Name of the queue(s), from where system will consume messages. Use comma as a separator when specifying multiple queues.</div>                                                | <div style="width:350px">command.queue</div>   |
| <div style="width:150px">Addresses</div>     | M                                       | String                                  | <div style="width:400px">Address of target AMQP server.<pre style="background-color: #F5F5F7"><code style="color: #000000">server1:12345</code></pre></div>                                            | <div style="width:350px">localhost:15672</div> |
| <div style="width:150px">Username</div>      | O                                       | String                                  | <div style="width:400px">Username value, required for authenticated access. To avoid security issues, suggest utilizing a reference to respective secured variable, that holds a username value.</div> | <div style="width:350px">N/A</div>             |
| <div style="width:150px">Password</div>      | O                                       | String                                  | <div style="width:400px">Password value, required for authenticated access. To avoid security issues, suggest utilizing a reference to respective secured variable, that holds a username value.</div> | <div style="width:350px">N/A</div>             |
| <div style="width:150px">Exchange Name</div> | M                                       | String                                  | <div style="width:400px">Determines the exchange, messages will be pulled from.</div>                                                                                                                  | <div style="width:350px">logs</div>            |
| <div style="width:150px">Routing Key</div>   | O                                       | String                                  | <div style="width:400px">The routing key to use when binding a consumer queue to the exchange.</div>                                                                                                   | <div style="width:350px">rkey-1</div>          |

- **"MaaS"** connection source type

| Parameter                                                 | <div style="width:75px">Mandatory</div> | <div style="width:75px">Data Type</div> | Description                                                                                                                                                                                                                                            | Sample                                       |
| --------------------------------------------------------- | :-------------------------------------- | :-------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | -------------------------------------------- |
| <div style="width:150px">Vhost MaaS Classifier Name</div> | M                                       | String                                  | <div style="width:400px">Vhost classifier name. <br/> **Default value:** public.</div>                                                                                                                                                                 | <div style="width:350px">public</div>        |
| <div style="width:150px">Classifier Namespace</div>       | O                                       | String                                  | <div style="width:400px">Specifies classifier namespace, that shall be used instead of default one. If left empty, default namespace will be utilized. Only works, when MaaS has a security permission rule to access a different namespace.</div>     | <div style="width:350px">newNamespace</div>  |
| <div style="width:150px">Exchange Name</div>              | M                                       | String                                  | <div style="width:400px">Determines the exchange, produced messages will be sent to.</div>                                                                                                                                                             | <div style="width:350px">logs</div>          |
| <div style="width:150px">Queue(s) Name</div>              | M                                       | String                                  | <div style="width:400px">Name of the queue(s), from where system will consume messages. When entered data is missing in MaaS, system shows warning icon with respective "tip" message. Use comma as a separator when specifying multiple queues.</div> | <div style="width:350px">command.queue</div> |
| <div style="width:150px">Routing Key</div>                | O                                       | String                                  | <div style="width:400px">The routing key to use when binding a consumer queue to the exchange.</div>                                                                                                                                                   | <div style="width:350px">rkey1</div>         |

#### Advanced Parameters
| Parameter                                                | <div style="width:75px">Mandatory</div> | <div style="width:75px">Data Type</div> | Description                                                                                                                                                                                                                                                                                                                                                                                                                  | Sample                                                |
| -------------------------------------------------------- | :-------------------------------------- | :-------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------- |
| <div style="width:150px">Acknowledge Mode </div>         | M                                       | List                                    | <div style="width:400px">Controls the way the acknowledge is being sent. <ul><li>NONE - no acknowledgment will be sent.</li><li>MANUAL - system will send an acknowledgment (ack) or negative acknowledgment (nack) immediately after receiving the message.</li><li>AUTO - normal or negative acknowledgment will be sent only when chain finishes and system operates normally.</li></ul><b>Default value: </b> AUTO</div> | <div style="width:350px">N/A</div>                    |
| <div style="width:150px">Exchange Type</div>             | M                                       | List                                    | <div style="width:400px">The exchange type such as direct or topic. Enum values: <ul><li>direct</li><li>fanout</li><li>headers</li><li>topic</li></ul><b>Default value: </b> direct</div>                                                                                                                                                                                                                                    | <div style="width:350px">direct</div>                 |
| <div style="width:150px">Dead Letter Exchange</div>      | O                                       | String                                  | <div style="width:400px">The name of the dead letter exchange, to where invalid/dropped messages will be catered.</div>                                                                                                                                                                                                                                                                                                      | <div style="width:350px">x-dead-letter-exchange</div> |
| <div style="width:150px">Dead Letter Exchange Type</div> | O                                       | List                                    | <div style="width:400px">The type of the dead letter exchange.Enum values:<ul><li>direct</li><li>fanout</li><li>headers</li><li>topic</li></ul><b>Default value: </b> direct</div>                                                                                                                                                                                                                                           | <div style="width:350px">direct</div>                 |
| <div style="width:150px">Dead Letter Queue</div>         | O                                       | String                                  | <div style="width:400px">The name of the dead letter queue, to where invalid/dropped messages will be catered.</div>                                                                                                                                                                                                                                                                                                         | <div style="width:350px">basic.queue</div>            |
| <div style="width:150px">Dead Letter Routing Key</div>   | O                                       | String                                  | <div style="width:400px">The routing key to use when binding a consumer dead letter queue to the dead letter exchange.</div>                                                                                                                                                                                                                                                                                                 | <div style="width:350px">dlrkey1</div>                |

#### Metadata
| Parameter                                  | <div style="width:75px">Mandatory</div> | <div style="width:75px">Data Type</div> | Description                                                                               | Sample                                                                               |
| ------------------------------------------ | :-------------------------------------- | :-------------------------------------- | ----------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------ |
| <div style="width:150px">Name</div>        | M                                       | String                                  | <div style="width:400px">Name of the element.</div>                                       | <div style="width:350px">RabbitMQ Trigger</div>                                      |
| <div style="width:150px">Description</div> | O                                       | String                                  | <div style="width:400px">Free text field, that contains description of the element.</div> | <div style="width:350px">Trigger consumes notification requests from the queue</div> |

### "Idempotency" Tab
This tab allows setting idempotent behavior in order to avoid processing of the same message by one consumer (especially relevant for Blue-Green deployment approach). The Exchange which has the same idempotency key is regarded as a duplicate. Duplication check is performing on full idempotency key, which has the following structure:
<pre style="background-color: #F5F5F7"><style> .line-numbers-rows { display: none !important; }</style><code style="color: #000000">&lt;idempotency-key&gt; = dupcheck:&lt;context-expression&gt;:&lt;key-expression&gt;</code></pre>

where ```<context-expression>``` and ```<key-expression>``` are fully configurable parts (see the table with parameters description below).

<div style="background-color: #e7f3fe; border-left: 6px solid #2196F3; padding: 10px">The <code>&lt;context-expression&gt;</code> and <code>&lt;key-expression&gt;</code> values can be retrieved via system properties <b><code>systemProperty_idempotencyContext</code></b> and <b><code>systemProperty_idempotencyKey</code></b>, respectively.</div>

The following parameters are available on the tab:
- **Enabled** checkbox - main parameter, which defines whether idempotency will be applied (checked) for trigger or not. Default value: unchecked. If checked, the following set of parameters becomes editable:

| Parameter                                                    | <div style="width:75px">Mandatory</div> | <div style="width:75px">Data Type</div> | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                  | Sample                                                          |
| ------------------------------------------------------------ | :-------------------------------------- | :-------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | --------------------------------------------------------------- |
| <div style="width:150px">Context expression</div>            | лю                                       | String                                  | <div style="width:400px">Field should contain some meaningful value that is unique across all the other chains. Supports Camel Simple language. For example you may use: <ul><li><code>\<exchange name> + \<queue></code></li><li><code>\<classifier> + \<queue></code>, etc.</li></ul></div>                                                                                                                                                                | <div style="width:350px">logs-command.queue</div>               |
| <div style="width:150px">Key expression</div>                | M                                       | String                                  | <div style="width:400px">Free text field that supports Camel Simple language. Key examples:<ul><li>From message header: <code>${header.header_name}</code></li><li>From message body part: <code>${jq('.field_name')}</code>, <code>${jsonpath('$.field_name')}</code>, <code> ${xpath('/root/field_name/text()')}</code></li></ul></li></ul></div>                                                                                                          | <div style="width:350px"><code>${jsonpath('$.id')}</code></div> |
| <div style="width:150px">Key expiration time (seconds)</div> | O                                       | String                                  | <div style="width:400px">Specifies time in seconds after which idempotency key will be expired<br><b>Default value:</b> 600</div><br><div style="background-color: #e7f3fe; border-left: 6px solid #2196F3; padding: 10px">The Key expiration time (seconds) value can be retrieved via system property <b><code>systemProperty_keyExpiry</code></b></div>                                                                                                   | <div style="width:350px">600</div>                              |
| <div style="width:150px">Action on duplicate</div>           | M                                       | List                                    | <div style="width:400px">Defines action that should be performed in case of key duplication detected. Possible values:<li><i>Ignore</i> - stop session and do not process the call</li><li><i>Throw exception</i> - raise exception and stop call processing</li><li><i>Execute subchain</i> - call selected chain via Chain Trigger. In case this option has been chosen, two more parameters (below in the table) becomes visible and editable.</li></div> | <div style="width:350px">Throw exception</div>                  |
| <div style="width:150px">Chain trigger</div>                 | C                                       | List                                    | <div style="width:400px">Dropdown list, that contains all chains with [Chain Trigger](docs/01__Chains/1__Graph/1__QIP_Elements_Library/6__Triggers/2__Chain_Trigger/chain_trigger.md) elements. Select one which has to be triggered in case of idempotency key duplication.<br><br>Visible only if <b>"Action on duplicate"</b> is <i>"Execute subchain"</i>.</div>                                                                                         | <div style="width:350px">Idempotency handling subchain</div>    |
| <div style="width:150px">Chain call timeout (ms)</div>       | C                                       | String                                  | <div style="width:400px">Timeout in milliseconds for calling the chain with [Chain Trigger](docs/01__Chains/1__Graph/1__QIP_Elements_Library/6__Triggers/2__Chain_Trigger/chain_trigger.md) element. If timeout is reached, session will fail. When left blank, default value will be applied.<br><b>Default value:</b> 600<br><br>Visible only if <b>"Action on duplicate"</b> is <i>"Execute subchain"</i>.</div>                                          | <div style="width:350px">30000</div>                            |

## Constraints

---
Can't set input dependency to this element.