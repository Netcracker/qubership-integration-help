# Tutorial on the Apache Groovy
## Description

---
When it is required to enter a script in the specific QIP element, it must be entered in **Groovy** programming language. By utilizing the syntax of this language, it is possible to access wide scope of instruments, allowing to build mapping, validations, operate with exchange data, etc. This page contains a list of commonly-used scenarios and script examples to fulfill them.

## Application in QIP

---
According to groovy, you can set a suitable kind of scripts, error handling, input/output messages. System displays the code completion popup automatically as user types.

There is a list of modules where you can use Groovy:

1. [Script](docs/01__Chains/1__Graph/1__QIP_Elements_Library/5__Transformation/1__Script/script.md) - the most common module used for creating any scripts of data transformation or something else. For example:
   1. Parsing of incoming messages
   2. Set/Get variable(s) in the Camel Context
   3. Error handling.
2. [Service Call](docs/01__Chains/1__Graph/1__QIP_Elements_Library/7__Senders/6__Service_Call/service_call.md) - embedded Scripting module, so the same functionality as for Script.


### Common Cases

[//]: # (<style>)

[//]: # (pre {)

[//]: # (  border: 1px solid #999;)

[//]: # (  display: block;)

[//]: # (})

[//]: # (</style>)

| #   | Scenario                                                                                                                                                                                                                                                                                                                                                                                                            | Example                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| --- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| 1   | <div style="width:300px">Library import                                                                                                                                                                                                                                                                                                                                                                             | <div style="width:800px"><pre style="background-color: #F5F5F7"><code style="color: #000000">import groovy.json.JsonSlurper;</code><br/><code style="color: #000000">import groovy.json.JsonOutput;</code></pre></div>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| 2   | <div style="width:300px">Obtaining the message body from Camel Exchange</div>                                                                                                                                                                                                                                                                                                                                       | <div style="width:800px"><pre style="background-color: #F5F5F7"><code style="color: #000000">def requestBody = exchange.getMessage().getBody(String.class);</code></pre></div>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| 3   | <div style="width:300px">Parsing body from Camel Exchange</div>                                                                                                                                                                                                                                                                                                                                                     | <div style="width:800px"><pre style="background-color: #F5F5F7"><code style="color: #000000">def requestJSON = new groovy.json.JsonSlurper.parseText(exchange.getMessage().getBody(String.class));</code></pre></div>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| 4   | <div style="width:300px">Get field value from JSON body</div>                                                                                                                                                                                                                                                                                                                                                       | <div style="width:800px"><pre style="background-color: #F5F5F7"><code style="color: #000000">def requestJSON = new groovy.json.JsonSlurper.parseText(exchange.getMessage().getBody(String.class));</code><br/><code style="color: #000000">def id = requestJSON.id;</code></pre></div>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| 5   | <div style="width:300px">Put some fields to JSON body</div>                                                                                                                                                                                                                                                                                                                                                         | <div style="width:800px"><pre style="background-color: #F5F5F7"><code style="color: #000000">import groovy.json.JsonSlurper;import groovy.json.JsonOutput;</code><br/><code style="color: #000000">def slurper = new JsonSlurper();</code><br/><code style="color: #000000">def requestJSON = slurper.parseText(exchange.getMessage().getBody(String.class));<code style="color: #000000"><br/><code style="color: #000000">requestJSON.put("fieldName", "fieldValue");</code></pre></div>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| 6   | <div style="width:300px">Set property to Camel Exchange<br/><br/><div style="background-color: #e7f3fe; border-left: 6px solid #2196F3; padding: 10px"><b>Note:</b><br/>Property setting might be useful for storing values, that are necessary for the further chain processing (in another scripting modules, Choice, etc.)</div></div></div>                                                                     | <div style="width:800px"><pre style="background-color: #F5F5F7"><code style="color: #000000">exchange.setProperty("propertyName", "propertyValue");</code></pre></div>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| 7   | <div style="width:300px">Get property from Camel Exchange</div>                                                                                                                                                                                                                                                                                                                                                     | <div style="width:800px"><pre style="background-color: #F5F5F7"><code style="color: #000000">exchange.getProperty("propertyName");</code></pre></div>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| 8   | <div style="width:300px">Function declaration</div>                                                                                                                                                                                                                                                                                                                                                                 | <div style="width:800px"><pre style="background-color: #F5F5F7"><code style="color: #000000">def validateCustomerData(requestJSON){</code><br/><code style="color: #000000">def result = false;</code><br/><code style="color: #000000">def userData = getUserData(requestJSON);</code><br/><code style="color: #000000">result = (userData.firstName != null) && (userData.lastName != null) && (userData.email != null);</code><br/><code style="color: #000000">return result;<br/>}</code></pre></div>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| 9   | <div style="width:300px">Build the JSON body</div>                                                                                                                                                                                                                                                                                                                                                                  | <div style="width:800px"><b>First option (more applicable):</b><pre style="background-color: #F5F5F7"><code style="color: #000000">String variable = "value";</code><br/><code style="color: #000000">def jsonBody = new groovy.json.JsonBuilder(</code><br/><code style="color: #000000">["primitive": "string",</code><br/><code style="color: #000000">"object": [ "objectField": 2 ],</code><br/><code style="color: #000000">"objectsArray": [ [ "objectField": 1 ], ["objectField": 2] ],</code><br/><code style="color: #000000">"variable": variable,</code><br/><code style="color: #000000">"primitivesArray":["value1", "value2"]]);</code></pre> The result of first option would be:<pre style="background-color: #F5F5F7"><code style="color: #000000">{</code><br/><code style="color: #000000">    "primitive":"string",</code><br/><code style="color: #000000">    "object":{"objectField":2},</code><br/><code style="color: #000000">    "objectsArray":[ { "objectField": 1 }, { "objectField": 2 } ],</code><br/><code style="color: #000000">    "variable":"value",</code><br/><code style="color: #000000">    "primitivesArray":["value1","value2"]</code><br/><code style="color: #000000">}</code></pre><b>Second option:</b> <pre style="background-color: #F5F5F7"><code style="color: #000000">def builder = new groovy.json.JsonBuilder()</code><br/><code style="color: #000000">def root = builder {</code><br/><code style="color: #000000">person {</code><br/><code style="color: #000000">firstName 'Guillame'</code><br/><code style="color: #000000">lastName 'Laforge'                // Named arguments are valid values for objects too</code><br/><code style="color: #000000">address(</code><br/><code style="color: #000000">city: 'Paris',</code><br/><code style="color: #000000">country: 'France',</code><br/><code style="color: #000000">zip: 12345,)</code><br/><code style="color: #000000">married true                // a list of values</code><br/><code style="color: #000000">conferences 'JavaOne', 'Gr8conf'</code><br/><code style="color: #000000">}<br/></code>} </code><br/><code style="color: #000000">def out = new groovy.json.JsonOutput().toJson(root);</code></pre> The result of second option would be: <pre style="background-color: #F5F5F7"><code style="color: #000000">{</code><br/><code style="color: #000000">    "person": {</code><br/><code style="color: #000000">        "firstName": "Guillame",</code><br/><code style="color: #000000">        "lastName": "Laforge",</code><br/><code style="color: #000000">        "address": {"city": "Paris","country": "France","zip": 12345},</code><br/><code style="color: #000000">        "married": true,</code><br/><code style="color: #000000">        "conferences": ["JavaOne","Gr8conf"]</code><br/><code style="color: #000000">    }</code><br/><code style="color: #000000">}</code></pre></div> |
| 10  | <div style="width:300px">Configuring response code & body</div>                                                                                                                                                                                                                                                                                                                                                     | <div style="width:800px"><pre style="background-color: #F5F5F7"><code style="color: #000000">exchange.getMessage().setHeader('CamelHttpResponseCode','400');</code><br/><code style="color: #000000">exchange.getMessage().setBody('Invalid data');</code></pre><br/>The result would be having customized message "Invalid data", instead of standard one when code "400" received.</div>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| 11  | <div style="width:300px">Set header and body</div>                                                                                                                                                                                                                                                                                                                                                                  | <div style="width:800px"><pre style="background-color: #F5F5F7"><code style="color: #000000">exchange.getMessage().setHeader("Content-Type","application/json");</code><br/><code style="color: #000000">exchange.getMessage().setBody(JsonOutput.toJson("{"id":"1"}"));</code><br/><code style="color: #000000">exchange.setBody(slurper.parseText(exchange.getProperty("requestQuote", String.class)); </code></pre></div>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| 12  | <div style="width:300px">Remove header & body</div>                                                                                                                                                                                                                                                                                                                                                                 | <div style="width:800px"><pre style="background-color: #F5F5F7"><code style="color: #000000">exchange.getMessage().removeHeader('authorization');</code><br/><code style="color: #000000">exchange.getMessage().removeHeaders("*"); // remove all headers</code><br/><code style="color: #000000">exchange.getMessage().setBody(null);</code></pre></div>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| 13  | <div style="width:300px">Get path parameters</div>                                                                                                                                                                                                                                                                                                                                                                  | <div style="width:800px">The same method as for scenario #7:<pre style="background-color: #F5F5F7"><code style="color: #000000">def path_parameter = exchange.getProperty("path_parameter_name");</code></pre></div>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| 14  | <div style="width:300px">Get query parameters</div>                                                                                                                                                                                                                                                                                                                                                                 | <div style="width:800px"><pre style="background-color: #F5F5F7"><code  style="color: #000000">def query_parameter = exchange.getMessage().getHeader("query_parameter_name);</code></pre></div>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| 15  | <div style="width:300px">Get variable value<br/><br/><div style="background-color: #e7f3fe; border-left: 6px solid #2196F3; padding: 10px"><b>Note:</b><br/>More detailed information about secured variables available in  <a href="doc/03__Admin_Tools/2__Variables/variables.md">Variables</a>.</div></div>                                                                                                      | <div style="width:800px"><pre style="background-color: #F5F5F7"><code style="color: #000000">def somevalue = #{secured_variable_name};</code><br/><code style="color: #000000">String urlEncodedBody = "username=" + "#{username}".encodeURL();</code></pre></div>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| 16  | <div style="width:300px">Generate UUID</div>                                                                                                                                                                                                                                                                                                                                                                        | <div style="width:800px"><pre style="background-color: #F5F5F7"><code style="color: #000000">def uuid = UUID.randomUUID();</code></pre></div>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| 17  | <div style="width:300px">Get data from technical context</div>                                                                                                                                                                                                                                                                                                                                                      | <div style="width:800px"><pre style="background-color: #F5F5F7"><code style="color: #000000">import.context.propagation.core.ContextManager;</code><br/><code style="color: #000000">ContextManager.get(x_request_id);</code></pre></div>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| 18  | <div style="width:300px">Log some information</div>                                                                                                                                                                                                                                                                                                                                                                 | <div style="width:800px">Log any information:<pre style="background-color: #F5F5F7"><code style="color: #000000">java.util.logging.Logger.getLogger().info("I am a test info log");</code></pre>Log an error: <pre style="background-color: #F5F5F7"><code style="color: #000000">java.util.logging.Logger.getLogger().severe("test error log");</code></pre></div>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| 19  | <div style="width:300px">Get exception from "Try-Catch-Finally" module (works only for scripts after "Catch"</div>                                                                                                                                                                                                                                                                                                  | <div style="width:800px"><pre style="background-color: #F5F5F7"><code style="color: #000000">Throwable caused = exchange.getProperty("CamelExceptionCaught", Throwable.class);</code></pre></div>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| 20  | <div style="width:300px">Disable Unicode escaping.<br/><div style="background-color: #e7f3fe; border-left: 6px solid #2196F3; padding: 10px"><b>Note:</b><br/>When working with non-ASCII characters (e.g. hieroglyphs or specific symbols, used in some countries), this might be necessary to disable Unicode escaping to see the original value, instead of its escaped option, like "\u0048\u0065".</div></div> | <div style="width:800px"><pre style="background-color: #F5F5F7"><code style="color: #000000">def generator = new JsonGenerator.Options().disableUnicodeEscaping().build()</code><br/><code style="color: #000000">exchange.getMessage().setBody(generator.toJson(outputResult))</code>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| 21  | <div style="width:300px">Parsing multipart/form-data</div>                                                                                                                                                                                                                                                                                                                                                          | <div style="width:800px"><pre style="background-color: #F5F5F7"><code style="color: #000000">import java.io.ByteArrayInputStream;</code><br/><code style="color: #000000">import java.io.ByteArrayOutputStream;</code><br/><code style="color: #000000">import org.apache.tomcat.util.http.fileupload.FileUploadBase;</code><br/><code style="color: #000000">import org.apache.tomcat.util.http.fileupload.MultipartStream;</code><br/><br/><code style="color: #000000">byte[] body = exchange.getMessage().getBody(String.class).getBytes();</code><br/><code style="color: #000000">byte[] boundary = (exchange.getMessage().getHeader(FileUploadBase.CONTENT_TYPE).split("boundary=")[1]).getBytes();</code><br/><br/><code style="color: #000000">ByteArrayInputStream content = new ByteArrayInputStream(body);</code><br/><code style="color: #000000">MultipartStream multipartStream = new MultipartStream(content, boundary, MultipartStream.DEFAULT_BUFSIZE, null);</code><br/><br/><code style="color: #000000">boolean nextPart = multipartStream.skipPreamble();</code><br/><code style="color: #000000">while (nextPart) {</code><br/><code style="color: #000000">    String headers = multipartStream.readHeaders();</code><br/><code style="color: #000000">    ByteArrayOutputStream partContent = new ByteArrayOutputStream();</code><br/><code style="color: #000000">    multipartStream.readBodyData(partContent);</code><br/><br/><code style="color: #000000">    // ...</code><br/><br/><code style="color: #000000">    nextPart = multipartStream.readBoundary();</code><br/><code style="color: #000000">}</code></pre></div>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |

## Constraints

---
While configuring **Script**, it is not possible to import classes, defined in another **Script**, as they are isolated from each other on class loader level. Attempting to perform such import will lead to deployment issues.