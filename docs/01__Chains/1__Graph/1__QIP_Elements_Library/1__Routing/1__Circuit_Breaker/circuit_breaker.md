# Circuit Breaker
## Description

---
**Circuit Breaker** element is intended to prevent the invocation of outbound service when service malfunction is detected, and failure threshold reached. This element is mainly used with [Service Call](docs/01__Chains/1__Graph/1__QIP_Elements_Library/7__Senders/6__Service_Call/service_call.md) or [HTTP Sender](docs/01__Chains/1__Graph/1__QIP_Elements_Library/7__Senders/4__HTTP_Sender/http_sender.md).

The Circuit Breaker switches between three states:

- **Closed** — default state, Circuit Breaker stays in this state while integration works normally. In this state, Circuit breaker allows invoking outbound service and don't interfere into integration flow.
- **Open** — Circuit Breaker switches to this state, when requests failures reach the configured threshold. In this state, the circuit breaker disrupts integration with malfunctioned outbound service, decreasing the load on the struggling service and integration route.
- **Half Open** — after configured amount of time, Circuit Breaker switched to this state and allows to invoke outbound service to insure whenever it is capable to accept the requests. Depending on the outcome, Circuit Breaker either switches to Open or Closed state.

## User Interface

---
### "Parameters" Tab (Circuit Breaker)
#### Metadata

| Parameter                                   | <div style="width:75px">Mandatory</div>   | <div style="width:75px">Data Type</div>  | Description                                                                   | Sample                                                        |
|---------------------------------------------|:------------------------------------------|:-----------------------------------------|-------------------------------------------------------------------------------|---------------------------------------------------------------|
| <div style="width:150px">Name</div>         | M                                         | String                                   | <div style="width:400px">Name of the Circuit Breaker container element.</div> | <div style="width:350px">Circuit Breaker #1</div>             |
| <div style="width:150px">Description </div> | O                                         | String                                   | <div style="width:400px">Free text field for element description.</div>       | <div style="width:350px">Check failures for operation A</div> |

### "Parameters" Tab (Circuit Breaker Configuration)
#### Common Parameters
| Parameter                                                                   | <div style="width:75px">Mandatory</div> | <div style="width:75px">Data Type</div> | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | Sample                                     |
| --------------------------------------------------------------------------- | :-------------------------------------- | :-------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ------------------------------------------ |
| <div style="width:150px">Automatic transition from open to half open state  | O                                       | Boolean                                 | <div style="width:400px">Checkbox, that enables automatic transition from OPEN to HALF_OPEN state once the time, configured in "Wait duration in open state" has passed.</div>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | <div style="width:350px">Unchecked </div>  |
| <div style="width:150px">Failure rate threshold</div>                       | M                                       | Number                                  | <div style="width:400px">Configures the failure rate threshold in percentage. If the failure rate is <b>equal</b> or <b>greater</b> than the threshold - the Circuit Breaker transitions to <b>Open State</b> and starts short-circuiting calls.<br/>The threshold must be greater than 0 and not greater than 100.<br/> <b>Default value:</b> 50 </div>                                                                                                                                                                                                                                                                                                                 | <div style="width:350px">50 </div>         |
| <div style="width:150px">Minimum number of calls </div>                     | M                                       | Number                                  | <div style="width:400px">Configures the minimum number of calls before the Circuit Breaker can calculate the failure rate. For example, if <b>"Minimum number of calls"</b> is 10, then at least 10 calls must be recorded, before the failure rate can be calculated. If only 9 calls have been recorded the Circuit Breaker will not transition to open even if all 9 calls have failed.<br/>"Minimum number of calls" must be greater than 0.<br/><b>Default value:</b> 100 </div>                                                                                                                                                                                    | <div style="width:350px">100 </div>        |
| <div style="width:150px">Permitted number of calls in half open state</div> | M                                       | Number                                  | <div style="width:400px">Configures the number of permitted calls when the Circuit Breaker is Half Open. When settled number of successful calls is being made in Half Open state, Circuit Breaker transitions to "Closed" state. <br/>The size must be greater than 0.<br/><b>Default value:</b> 10.</div>                                                                                                                                                                                                                                                                                                                                                              | <div style="width:350px">10</div>          |
| <div style="width:150px">Sliding window size   </div>                       | M                                       | Number                                  | <div style="width:400px">Configures the size of the sliding window which is used to record the outcome of calls when the Circuit Breaker is <b>Closed</b>. This is the range, within which the Circuit Breaker will be validating the failure rate. The value will be considered as <b>number of calls</b>, if the <b>"Sliding window type"</b> is COUNT_BASED, and as <b>seconds</b>, if the <b>"Sliding window type</b> is TIME_BASED.<br/><ul><li>"Sliding window size" must be greater than 0</li><li>"Sliding window size" must be greater than value in "Minimum number of calls", if Sliding window type is COUNT_BASED</li></ul><b>Default value:</b> 100 </div> | <div style="width:350px">100</div>         |
| <div style="width:150px">Sliding window type   </div>                       | O                                       | List                                    | <div style="width:400px">Configures the type of the sliding window, which is used to record the outcome of calls when the Circuit Breaker is closed.<ul><li>COUNT_BASED type means that Circuit Breaker will be sequentially aggregating the calls and control the window size by the number of calls.</li><li>TIME_BASED type means that Circuit Breaker will control the window size via time interval.</li></ul><b>Default value:</b> COUNT_BASED. </div>                                                                                                                                                                                                             | <div style="width:350px">COUNT_BASED</div> |
| <div style="width:150px">Slow call duration threshold (s)</div>             | M                                       | Number                                  | <div style="width:400px">Configures the call duration in seconds, above which calls are considered as slow and increase the slow calls percentage.<br/><b>Default value:<b> 60 </div>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | <div style="width:350px">100 </div>        |
| <div style="width:150px">Slow call rate threshold (%) </div>                | M                                       | Number                                  | <div style="width:400px">Configures a threshold in percentage. The Circuit Breaker considers a call as slow when the call duration is greater than value in <b>"Slow call duration threshold"</b>. When the percentage of slow calls is <b>equal</b> or <b>greater</b> the threshold, the Circuit Breaker transitions to <b>Open state</b> and starts short-circuiting calls.<br/>The threshold must be greater than 0 and not greater than 100.<br/><b>Default value:</b> 100</div>                                                                                                                                                                                     | <div style="width:350px">60 </div>         |
| <div style="width:150px">Wait duration in open state (s)  </div>            | M                                       | Number                                  | <div style="width:400px">Configures the wait duration (in seconds) which specifies how long the Circuit Breaker should stay open, before it switches to half open.<br/><b>Default value:</b> 60  </div>                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | <div style="width:350px">60  </div>        |


#### Metadata

| Parameter                                  | <div style="width:75px">Mandatory</div>   | <div style="width:75px">Data Type</div>  | Description                                                                                 | Sample                                                       |
|--------------------------------------------|:------------------------------------------|:-----------------------------------------|---------------------------------------------------------------------------------------------|--------------------------------------------------------------|
| <div style="width:150px">Name</div>        | M                                         | String                                   | <div style="width:400px">Name of the Circuit Breaker Configuration container element.</div> | <div style="width:350px">Circuit Breaker Configuration</div> |
| <div style="width:150px">Description</div> | O                                         | String                                   | <div style="width:400px">Free text field for element description.</div>                     | <div style="width:350px">Detailed settings</div>             |


### "Parameters" Tab (On Fallback)
#### Metadata
| Parameter                                  | <div style="width:75px">Mandatory</div>   | <div style="width:75px">Data Type</div>   | Description                                                               | Sample                                           |
|--------------------------------------------|:------------------------------------------|:------------------------------------------|---------------------------------------------------------------------------|--------------------------------------------------|
| <div style="width:150px">Name</div>        | M                                         | String                                    | <div style="width:400px">Name of the Fallback container element.</div>    | <div style="width:350px">On fallback</div>       |
| <div style="width:150px">Description</div> | O                                         | String                                    | <div style="width:400px">Free text field for element description.</div>   | <div style="width:350px">Fallback actions</div>  |

## Constraints

---
Please consider next constraints:
- Only one instance of "**Circuit Breaker Configuration**" can be added to Circuit Breaker module.
- Only one instance of "**On Fallback**" can be added to Circuit Breaker module.
- When circuit breaker fails, all processing data within circuit breaker configuration branch, including headers, properties and body will be **erased**. This means, that there won't be any ability to refer to this data outside the configuration element, even via "On fallback" element.